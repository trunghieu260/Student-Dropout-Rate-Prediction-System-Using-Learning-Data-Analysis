<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng Ph√¢n t√≠ch R·ªßi ro Ngh·ªâ h·ªçc (Gemini AI Project)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .risk-high { background-color: #f8d7da; color: #721c24; }
        .risk-medium { background-color: #fff3cd; color: #856404; }
        .risk-low { background-color: #d4edda; color: #155724; }
        .table-container { max-height: 600px; overflow-y: auto; }
        .analyzing { opacity: 0.6; }
        #progress-container { display: none; }
        #dashboard-area { display: none; }
        .chart-container {
            position: relative;
            margin: auto;
            height: 40vh;
            width: 100%;
        }
        /* TH√äM CSS CHO CONTROLS */
        #controls-area { display: none; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Ph√¢n T√≠ch Kh·∫£ NƒÉng Ngh·ªâ H·ªçc </h1>
        
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-analysis" type="button">Ph√¢n T√≠ch ƒê∆°n L·∫ª</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch-analysis" type="button">Ph√¢n T√≠ch H√†ng Lo·∫°t (Excel)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">Dashboard</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="single-analysis">
                <div id="loading-single" class="alert alert-info d-none">ƒêang ph√¢n t√≠ch v·ªõi Gemini AI... Vui l√≤ng ch·ªù.</div>

                <form id="analysis-form" class="p-4 border rounded shadow-sm">
                    <h5 class="mb-3">Nh·∫≠p D·ªØ Li·ªáu Sinh Vi√™n</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tbchtH4" class="form-label">ƒêi·ªÉm TB Chung H·ªá 4</label>
                            <input type="number" step="0.01" min="0" max="4" class="form-control" id="tbchtH4" value="2.0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="hpNo" class="form-label">S·ªë H·ªçc ph·∫ßn N·ª£</label>
                            <input type="number" min="0" class="form-control" id="hpNo" value="3" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="diemRL" class="form-label">ƒêi·ªÉm R√®n Luy·ªán</label>
                            <input type="number" min="0" max="100" class="form-control" id="diemRL" value="75" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="xepLoai" class="form-label">X·∫øp Lo·∫°i H·ªçc t·∫≠p</label>
                            <select class="form-select" id="xepLoai" required>
                                <option value="Gi·ªèi">Gi·ªèi</option>
                                <option value="Kh√°" selected>Kh√°</option>
                                <option value="Trung b√¨nh">Trung b√¨nh</option>
                                <option value="Y·∫øu">Y·∫øu</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-3">Ph√¢n T√≠ch R·ªßi Ro</button>
                </form>

                <div id="result-area" class="mt-5 p-4 border rounded">
                    <h4 class="mb-3">K·∫øt Qu·∫£ Ph√¢n T√≠ch t·ª´ AI</h4>
                    <p>Nh·∫≠p d·ªØ li·ªáu v√† nh·∫•n n√∫t "Ph√¢n T√≠ch R·ªßi Ro" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                </div>
            </div>

            <div class="tab-pane fade" id="batch-analysis">
                <div class="p-4 border rounded shadow-sm">
                    <h5 class="mb-3">üìä T·∫£i File Excel Danh S√°ch Sinh Vi√™n</h5>
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">Ch·ªçn file Excel (.xlsx, .xls)</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
                        <small class="text-muted">File ph·∫£i c√≥ c√°c c·ªôt: M√£ SV, H·ªç v√† t√™n, L·ªõp, TBCHT H4, HP N·ª£, ƒêi·ªÉm RL, X·∫øp lo·∫°i, H·ªçc ph√≠</small>
                    </div>
                    <button id="analyzeBtn" class="btn btn-success w-100" disabled>Ph√¢n T√≠ch T·∫•t C·∫£ Sinh Vi√™n</button>
                </div>

                <div id="progress-container" class="mt-3">
                    <div class="alert alert-info">
                        <strong>ƒêang x·ª≠ l√Ω:</strong> <span id="progress-text">0/0</span>
                        <div class="progress mt-2">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div id="batch-result" class="mt-4">
                    <h5>K·∫øt Qu·∫£ Ph√¢n T√≠ch Chi Ti·∫øt</h5>
                    
                    <div id="controls-area" class="p-3 my-3 border rounded bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-7">
                                <label class="form-label fw-bold">üîé L·ªçc theo m·ª©c ƒë·ªô r·ªßi ro:</label>
                                <div id="filter-buttons" class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary active filter-btn" data-filter="all">T·∫•t c·∫£</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger filter-btn" data-filter="R·∫•t Cao">R·∫•t Cao</button>
                                    <button type="button" class="btn btn-sm btn-outline-warning filter-btn" data-filter="Cao">Cao</button>
                                    <button type="button" class="btn btn-sm btn-outline-info filter-btn" data-filter="Trung B√¨nh">Trung B√¨nh</button>
                                    <button type="button" class="btn btn-sm btn-outline-success filter-btn" data-filter="Th·∫•p">Th·∫•p</button>
                                </div>
                            </div>
                            <div class="col-md-5">
                                 <label for="sortOptions" class="form-label fw-bold">‚áÖ S·∫Øp x·∫øp theo:</label>
                                <select id="sortOptions" class="form-select form-select-sm">
                                    <option value="default" selected>M·∫∑c ƒë·ªãnh</option>
                                    <option value="risk-desc">R·ªßi ro gi·∫£m d·∫ßn</option>
                                    <option value="masv-asc">M√£ SV tƒÉng d·∫ßn</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-striped table-hover" id="resultTable" style="display:none;">
                            <thead class="table-dark">
                                <tr>
                                    <th>M√£ SV</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>L·ªõp</th>
                                    <th>TBCHT H4</th>
                                    <th>HP N·ª£</th>
                                    <th>ƒêi·ªÉm RL</th>
                                    <th>X·∫øp lo·∫°i</th>
                                    <th>H·ªçc ph√≠</th>
                                    <th>M·ª©c ƒê·ªô R·ªßi Ro</th>
                                    <th>Chi ti·∫øt</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody"></tbody>
                        </table>
                    </div>
                    <button id="exportBtn" class="btn btn-primary mt-3" style="display:none;">üì• Xu·∫•t K·∫øt Qu·∫£ (Excel)</button>
                </div>
            </div>

            <div class="tab-pane fade" id="dashboard">
                <div id="dashboard-area" class="mt-4 p-4 border rounded" style="display: none;">
                    <h3 class="text-center mb-4">üìà Dashboard T·ªïng Quan</h3>
                    <div class="row">
                        <!-- Bi·ªÉu ƒë·ªì hi·ªán c√≥ -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">T·ª∑ L·ªá R·ªßi Ro</h5>
                            <div class="chart-container">
                                <canvas id="riskPieChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">M·ª©c R·ªßi Ro Trung B√¨nh Theo L·ªõp</h5>
                            <div class="chart-container">
                                <canvas id="classBarChart"></canvas>
                            </div>
                        </div>
                        <!-- Bi·ªÉu ƒë·ªì m·ªõi -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">M·ªëi Quan H·ªá GPA vs HP N·ª£ (M√†u theo R·ªßi Ro)</h5>
                            <div class="chart-container">
                                <canvas id="gpaVsDebtScatter"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">Trung B√¨nh ƒêi·ªÉm R√®n Luy·ªán Theo M·ª©c R·ªßi Ro</h5>
                            <div class="chart-container">
                                <canvas id="rlByRiskBar"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">Chi ti·∫øt Ph√¢n t√≠ch R·ªßi ro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBodyContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyCSdImvFPXEZpzsNxxeWIDbdIRyV3Rb5eA"; // Vui l√≤ng thay b·∫±ng API Key c·ªßa b·∫°n
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        const responseSchema = {
            type: "object",
            properties: {
                Muc_do_rui_ro: { 
                    type: "string", 
                    enum: ["R·∫•t Cao", "Cao", "Trung B√¨nh", "Th·∫•p"], 
                    description: "M·ª©c ƒë·ªô r·ªßi ro ngh·ªâ h·ªçc d·ª± ƒëo√°n." 
                },
                Diem_tin_cay_phan_tich: { 
                    type: "number",
                    minimum: 0.0,
                    maximum: 1.0,
                    description: "ƒêi·ªÉm tin c·∫≠y c·ªßa ph√¢n t√≠ch (t·ª´ 0.0 ƒë·∫øn 1.0)." 
                },
                Giai_thich_chi_tiet: {
                    type: "array",
                    description: "C√°c y·∫øu t·ªë ch√≠nh d·∫´n ƒë·∫øn r·ªßi ro n√†y v√† ƒë·ªÅ xu·∫•t can thi·ªáp (t·ªëi ƒëa 4 √Ω).",
                    items: { type: "string" }
                }
            },
            required: ["Muc_do_rui_ro", "Giai_thich_chi_tiet"]
        };

        let studentsData = [];
        let riskPieChartInstance = null;
        let classBarChartInstance = null;
        let gpaVsDebtScatterInstance = null;
        let rlByRiskBarInstance = null;
        
        // BI·∫æN L∆ØU TR·∫†NG TH√ÅI L·ªåC V√Ä S·∫ÆP X·∫æP
        let currentFilter = 'all';
        let currentSort = 'default';

        // ===== TAB 1: PH√ÇN T√çCH ƒê∆†N L·∫∫ =====
        document.getElementById('analysis-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const tbchtH4 = parseFloat(document.getElementById('tbchtH4').value);
            const hpNo = parseInt(document.getElementById('hpNo').value);
            const diemRL = parseInt(document.getElementById('diemRL').value);
            const xepLoai = document.getElementById('xepLoai').value;

            document.getElementById('loading-single').classList.remove('d-none');
            document.getElementById('result-area').innerHTML = '<h4 class="mb-3">K·∫øt Qu·∫£ Ph√¢n T√≠ch t·ª´ AI</h4>';

            try {
                const result = await analyzeStudent({ tbchtH4, hpNo, diemRL, xepLoai });
                displaySingleResult(result);
            } catch (error) {
                document.getElementById('result-area').innerHTML += `<div class="alert alert-danger mt-3"><strong>L·ªói:</strong> ${error.message}</div>`;
            } finally {
                document.getElementById('loading-single').classList.add('d-none');
            }
        });

        // ===== TAB 2: PH√ÇN T√çCH H√ÄNG LO·∫†T =====
        document.getElementById('excelFile').addEventListener('change', function(e) {
             const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    let jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });

                    if (jsonData.length === 0) {
                        alert('‚ö†Ô∏è File Excel tr·ªëng!');
                        return;
                    }

                    // Find header row by looking for 'M√£ SV' or similar
                    let headerRowIndex = -1;
                    let header = [];
                    for(let i = 0; i < Math.min(jsonData.length, 10); i++) {
                        const row = jsonData[i].map(cell => String(cell).toLowerCase().trim());
                        if (row.includes('m√£ sv') || row.includes('msv') || row.includes('m√£ sinh vi√™n')) {
                            headerRowIndex = i;
                            header = jsonData[i].map(cell => String(cell).trim());
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                         alert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d√≤ng ti√™u ƒë·ªÅ h·ª£p l·ªá. C·∫ßn c√≥ c·ªôt "M√£ SV".');
                         return;
                    }

                    const jsonDataObjects = XLSX.utils.sheet_to_json(firstSheet, { range: headerRowIndex, defval: '' });

                    studentsData = jsonDataObjects.map((row) => {
                        const normalizedRow = {};
                        for (const key in row) {
                            normalizedRow[key.toLowerCase().trim()] = row[key];
                        }
                        
                        return {
                            maSV: String(normalizedRow['m√£ sv'] || normalizedRow['msv'] || ''),
                            hoTen: String(normalizedRow['h·ªç v√† t√™n'] || normalizedRow['hoten'] || ''),
                            lop: String(normalizedRow['l·ªõp'] || normalizedRow['lop'] || ''),
                            tbchtH4: parseFloat(normalizedRow['tbcht h4'] || 0),
                            hpNo: parseInt(normalizedRow['hp n·ª£'] || 0),
                            diemRL: parseFloat(normalizedRow['ƒëi·ªÉm rl'] || 0),
                            xepLoai: String(normalizedRow['x·∫øp lo·∫°i'] || 'Trung b√¨nh'),
                            hocPhi: String(normalizedRow['h·ªçc ph√≠'] || '')
                        };
                    }).filter(s => s.maSV !== '' && s.maSV !== '0' && s.lop !== '');


                    if (studentsData.length === 0) {
                        alert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu sinh vi√™n h·ª£p l·ªá!\n\nVui l√≤ng ki·ªÉm tra file c√≥ c·ªôt "M√£ SV" v√† "L·ªõp" kh√¥ng.');
                        return;
                    }

                    document.getElementById('analyzeBtn').disabled = false;
                    alert(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng ${studentsData.length} sinh vi√™n!`);
                } catch (error) {
                    alert('‚ùå L·ªói ƒë·ªçc file Excel: ' + error.message);
                    console.error('Chi ti·∫øt l·ªói:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            if (studentsData.length === 0) return;

            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            progressContainer.style.display = 'block';
            document.getElementById('dashboard-area').style.display = 'none';
            document.getElementById('resultTable').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('controls-area').style.display = 'none';
            this.disabled = true;

            const results = [];
            for (let i = 0; i < studentsData.length; i++) {
                const student = studentsData[i];
                progressText.textContent = `${i + 1}/${studentsData.length}`;
                progressBar.style.width = `${((i + 1) / studentsData.length) * 100}%`;

                try {
                    const analysis = await analyzeStudent({
                        tbchtH4: student.tbchtH4, hpNo: student.hpNo,
                        diemRL: student.diemRL, xepLoai: student.xepLoai
                    });
                    results.push({ ...student, ...analysis, riskLevel: analysis.Muc_do_rui_ro, details: analysis.Giai_thich_chi_tiet });
                } catch (error) {
                    results.push({ ...student, riskLevel: 'L·ªói', details: [error.message] });
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            window.batchResults = results; // L∆∞u k·∫øt qu·∫£ g·ªëc
            applyFiltersAndSort(); // Hi·ªÉn th·ªã l·∫ßn ƒë·∫ßu
            updateDashboard(results);
            
            progressContainer.style.display = 'none';
            this.disabled = false;
            document.getElementById('resultTable').style.display = 'table';
            document.getElementById('exportBtn').style.display = 'block';
            document.getElementById('controls-area').style.display = 'block';

            // T·ª± ƒë·ªông chuy·ªÉn sang tab Dashboard sau khi ph√¢n t√≠ch xong
            document.getElementById('dashboard-tab').click();
        });

        document.getElementById('exportBtn').addEventListener('click', function() {
            const table = document.getElementById('resultTable');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, 'Ket_qua_phan_tich_rui_ro.xlsx');
        });
        
        // ===== H√ÄM M·ªöI ƒê·ªÇ V·∫º L·∫†I B·∫¢NG D·ªÆ LI·ªÜU =====
        function applyFiltersAndSort() {
            if (!window.batchResults) return;

            let dataToDisplay = [...window.batchResults];

            // 1. √Åp d·ª•ng b·ªô l·ªçc
            if (currentFilter !== 'all') {
                dataToDisplay = dataToDisplay.filter(r => r.riskLevel === currentFilter);
            }

            // 2. √Åp d·ª•ng s·∫Øp x·∫øp
            const riskScores = { 'R·∫•t Cao': 4, 'Cao': 3, 'Trung B√¨nh': 2, 'Th·∫•p': 1, 'L·ªói': 0 };
            if (currentSort === 'risk-desc') {
                dataToDisplay.sort((a, b) => (riskScores[b.riskLevel] || 0) - (riskScores[a.riskLevel] || 0));
            } else if (currentSort === 'masv-asc') {
                dataToDisplay.sort((a, b) => a.maSV.localeCompare(b.maSV));
            }

            // 3. V·∫Ω l·∫°i b·∫£ng
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = dataToDisplay.map(r => {
                const originalIndex = window.batchResults.findIndex(orig => orig.maSV === r.maSV);
                const colorClass = r.riskLevel === 'R·∫•t Cao' || r.riskLevel === 'Cao' ? 'risk-high' 
                                 : r.riskLevel === 'Trung B√¨nh' ? 'risk-medium' : 'risk-low';
                return `
                    <tr>
                        <td>${r.maSV}</td>
                        <td>${r.hoTen}</td>
                        <td>${r.lop}</td>
                        <td>${r.tbchtH4}</td>
                        <td>${r.hpNo}</td>
                        <td>${r.diemRL}</td>
                        <td>${r.xepLoai}</td>
                        <td>${r.hocPhi}</td>
                        <td class="${colorClass}"><strong>${r.riskLevel}</strong></td>
                        <td>
                            <button class="btn btn-sm btn-info" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#detailModal" 
                                    data-index="${originalIndex}">
                                Xem
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ===== L·∫ÆNG NGHE S·ª∞ KI·ªÜN CHO C√ÅC N√öT L·ªåC V√Ä S·∫ÆP X·∫æP =====
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i active cho n√∫t
                document.querySelector('.filter-btn.active').classList.remove('active');
                this.classList.add('active');
                
                // C·∫≠p nh·∫≠t bi·∫øn l·ªçc v√† v·∫Ω l·∫°i b·∫£ng
                currentFilter = this.dataset.filter;
                applyFiltersAndSort();
            });
        });

        document.getElementById('sortOptions').addEventListener('change', function() {
            currentSort = this.value;
            applyFiltersAndSort();
        });


        // ===== HELPER FUNCTIONS (Kh√¥ng thay ƒë·ªïi nhi·ªÅu) =====
        async function analyzeStudent(data) {
             const promptText = `
                B·∫°n l√† chuy√™n gia ph√¢n t√≠ch r·ªßi ro h·ªçc t·∫≠p v·ªõi 10 nƒÉm kinh nghi·ªám t·∫°i c√°c tr∆∞·ªùng ƒë·∫°i h·ªçc Vi·ªát Nam.
                
                NGUY√äN T·∫ÆC ƒê√ÅNH GI√Å R·ª¶I RO:
                - GPA < 2.0 v√† HP N·ª£ > 5: R·ªßi ro R·∫•t Cao
                - GPA 2.0-2.5 v√† HP N·ª£ 3-5: R·ªßi ro Cao  
                - GPA 2.5-3.0 v√† HP N·ª£ 1-2: R·ªßi ro Trung B√¨nh
                - GPA > 3.0 v√† HP N·ª£ = 0: R·ªßi ro Th·∫•p
                - ƒêi·ªÉm r√®n luy·ªán < 65 c≈©ng l√† y·∫øu t·ªë r·ªßi ro b·ªï sung

                D∆∞·ªõi ƒë√¢y l√† h·ªì s∆° c·ªßa sinh vi√™n:
                - ƒêi·ªÉm TB Chung H·ªá 4: ${data.tbchtH4}
                - S·ªë H·ªçc ph·∫ßn N·ª£: ${data.hpNo}
                - ƒêi·ªÉm R√®n Luy·ªán: ${data.diemRL}
                - X·∫øp Lo·∫°i H·ªçc t·∫≠p: ${data.xepLoai}

                H√£y ph√¢n t√≠ch v√† cung c·∫•p k·∫øt qu·∫£ theo ƒë·ªãnh d·∫°ng JSON.
            `;

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    }
                })
            });

            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error.message || 'L·ªói API kh√¥ng x√°c ƒë·ªãnh.');
            }

            if (!result.candidates || !result.candidates[0]?.content?.parts?.[0]?.text) {
                throw new Error('Gemini kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu h·ª£p l·ªá.');
            }

            return JSON.parse(result.candidates[0].content.parts[0].text);
        }

        function displaySingleResult(result) {
            const resultArea = document.getElementById('result-area');
            let colorClass = result.Muc_do_rui_ro === 'R·∫•t Cao' || result.Muc_do_rui_ro === 'Cao' ? 'risk-high' 
                           : result.Muc_do_rui_ro === 'Trung B√¨nh' ? 'risk-medium' : 'risk-low';

            const confidence = result.Diem_tin_cay_phan_tich ? (result.Diem_tin_cay_phan_tich * 100).toFixed(2) : 'N/A';

            resultArea.innerHTML = `
                <h4 class="mb-3">K·∫øt Qu·∫£ Ph√¢n T√≠ch t·ª´ AI</h4>
                <div class="p-3 rounded ${colorClass}">
                    <h5 class="mb-0">M·ª©c ƒê·ªô R·ªßi Ro: <strong>${result.Muc_do_rui_ro}</strong></h5>
                </div>
                <p class="mt-3">ƒêi·ªÉm tin c·∫≠y ph√¢n t√≠ch: <strong>${confidence}${confidence !== 'N/A' ? '%' : ''}</strong></p>
                <h5 class="mt-4">üí° Y·∫øu T·ªë Ch√≠nh & ƒê·ªÅ Xu·∫•t Can Thi·ªáp:</h5>
                <ul class="list-group">
                    ${result.Giai_thich_chi_tiet.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                </ul>
            `;
        }

        function updateDashboard(results) {
             document.getElementById('dashboard-area').style.display = 'block';

            const riskCounts = { 'R·∫•t Cao': 0, 'Cao': 0, 'Trung B√¨nh': 0, 'Th·∫•p': 0, 'L·ªói': 0 };
            results.forEach(r => {
                if (riskCounts.hasOwnProperty(r.riskLevel)) {
                    riskCounts[r.riskLevel]++;
                }
            });

            const riskScores = { 'R·∫•t Cao': 4, 'Cao': 3, 'Trung B√¨nh': 2, 'Th·∫•p': 1, 'L·ªói': 0 };
            const classRisk = {};

            results.forEach(r => {
                if (!r.lop) return; // B·ªè qua n·∫øu kh√¥ng c√≥ t√™n l·ªõp
                if (!classRisk[r.lop]) {
                    classRisk[r.lop] = { totalScore: 0, count: 0 };
                }
                classRisk[r.lop].totalScore += riskScores[r.riskLevel] || 0;
                classRisk[r.lop].count++;
            });

            const classLabels = Object.keys(classRisk);
            const classAvgScores = classLabels.map(lop => classRisk[lop].totalScore / classRisk[lop].count);

            // V·∫Ω bi·ªÉu ƒë·ªì tr√≤n
            const pieCtx = document.getElementById('riskPieChart').getContext('2d');
            if (riskPieChartInstance) riskPieChartInstance.destroy();
            riskPieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(riskCounts),
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng Sinh vi√™n',
                        data: Object.values(riskCounts),
                        backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#198754', '#6c757d'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });

            // V·∫Ω bi·ªÉu ƒë·ªì c·ªôt
            const barCtx = document.getElementById('classBarChart').getContext('2d');
            if (classBarChartInstance) classBarChartInstance.destroy();
            classBarChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: classLabels,
                    datasets: [{
                        label: 'M·ª©c R·ªßi Ro Trung B√¨nh (Th·∫•p=1, R·∫•t Cao=4)',
                        data: classAvgScores,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 4 } }, plugins: { legend: { display: false } } }
            });

            // Bi·ªÉu ƒë·ªì m·ªõi 1: Scatter Plot GPA vs HP N·ª£
            const riskColors = {
                'R·∫•t Cao': '#dc3545',
                'Cao': '#fd7e14',
                'Trung B√¨nh': '#ffc107',
                'Th·∫•p': '#198754',
                'L·ªói': '#6c757d'
            };

            const scatterData = results.map(r => ({
                x: r.tbchtH4,
                y: r.hpNo,
                backgroundColor: riskColors[r.riskLevel] || '#6c757d'
            }));

            const scatterCtx = document.getElementById('gpaVsDebtScatter').getContext('2d');
            if (gpaVsDebtScatterInstance) gpaVsDebtScatterInstance.destroy();
            gpaVsDebtScatterInstance = new Chart(scatterCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Sinh vi√™n',
                        data: scatterData,
                        backgroundColor: scatterData.map(d => d.backgroundColor),
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'GPA (TBCHT H4)' }, min: 0, max: 4 },
                        y: { title: { display: true, text: 'S·ªë HP N·ª£' }, min: 0 }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Bi·ªÉu ƒë·ªì m·ªõi 2: Bar Chart Trung b√¨nh ƒêi·ªÉm RL theo R·ªßi Ro
            const rlByRisk = { 'R·∫•t Cao': { total: 0, count: 0 }, 'Cao': { total: 0, count: 0 }, 
                               'Trung B√¨nh': { total: 0, count: 0 }, 'Th·∫•p': { total: 0, count: 0 }, 'L·ªói': { total: 0, count: 0 } };

            results.forEach(r => {
                if (rlByRisk[r.riskLevel]) {
                    rlByRisk[r.riskLevel].total += r.diemRL;
                    rlByRisk[r.riskLevel].count++;
                }
            });

            const rlLabels = Object.keys(rlByRisk);
            const rlAvg = rlLabels.map(key => rlByRisk[key].count > 0 ? (rlByRisk[key].total / rlByRisk[key].count).toFixed(2) : 0);

            const rlCtx = document.getElementById('rlByRiskBar').getContext('2d');
            if (rlByRiskBarInstance) rlByRiskBarInstance.destroy();
            rlByRiskBarInstance = new Chart(rlCtx, {
                type: 'bar',
                data: {
                    labels: rlLabels,
                    datasets: [{
                        label: 'Trung b√¨nh ƒêi·ªÉm RL',
                        data: rlAvg,
                        backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#198754', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        const detailModal = document.getElementById('detailModal');
        if (detailModal) {
            detailModal.addEventListener('show.bs.modal', function (event) {
                 const button = event.relatedTarget;
                const index = button.getAttribute('data-index');
                const result = window.batchResults[index];

                const modalTitle = detailModal.querySelector('.modal-title');
                const modalBody = detailModal.querySelector('.modal-body');

                modalTitle.textContent = `Ph√¢n t√≠ch cho SV: ${result.hoTen} (${result.maSV})`;
                
                const detailsHtml = `
                    <p class="mb-2"><strong>L·ªõp:</strong> ${result.lop}</p>
                    <p><strong>M·ª©c ƒê·ªô R·ªßi Ro:</strong> <span class="fw-bold">${result.riskLevel}</span></p>
                    <h5 class="mt-4">üí° Y·∫øu T·ªë Ch√≠nh & ƒê·ªÅ Xu·∫•t Can Thi·ªáp:</h5>
                    <ul class="list-group list-group-flush">
                        ${result.details.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                    </ul>
                `;
                modalBody.innerHTML = detailsHtml;
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>